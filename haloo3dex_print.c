
#include "haloo3dex_print.h"

// These are 8x8 glyphs for characters in the ascii range. If you try to
// print utf8, oh well
// clang-format off
const uint64_t haloo3d_print_basic_glyphs[256] = {
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	0,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	0,
	432352225974486528,
	38958471936,
	1963458503280401152,
	297154145763132416,
	1273135560880464128,
	2247781843980879616,
	8657438208,
	2019304794392763392,
	507807349747746560,
	453909248,
	289390378165993472,
	145247710822268928,
	34084860461056,
	434034414087831552,
	36454333991620608,
	2248336015737069312,
	4543019369991245568,
	4576082792943820544,
	2247771332738653952,
	3472345345151089664,
	2247771409768103808,
	2247772987668406016,
	108937465002311552,
	2247772986326228736,
	2247771474497740544,
	434034439958298624,
	289919251882442752,
	2021561039916630016,
	8725857422016512,
	508374654512005120,
	432352290954911488,
	2234240293915434752,
	3580853948646100480,
	2283801785492676480,
	2247720082261253888,
	1124124958752608128,
	4576081149738205056,
	108510319386673024,
	4553616125727981312,
	3580838615614337408,
	4543019369991257856,
	2247773059315416064,
	3574043392630960512,
	4576081089608647040,
	3580838572900200832,
	3580847403218219392,
	2247773065783123712,
	108510388914593664,
	3393952365088448256,
	3574043496315723648,
	2247771336253480704,
	868082074056933120,
	2247773065783128448,
	292200926074220928,
	3580849610797724032,
	3583632811505725824,
	868082152023208704,
	4576650141011296128,
	2234633151576219392,
	2319380248015339776,
	2240567306379337472,
	213054784512,
	4575657221408423936,
	262656,
	4553630911647711232,
	2283801862496944512,
	2247720288911360000,
	4553616075223216128,
	2234277659750170624,
	434041037993156096,
	2247365696948273152,
	3580838555179647360,
	4579048167059753984,
	2247771410044825600,
	3574045669566022016,
	4325427622847807872,
	3870199246464483328,
	3580838555179548672,
	2247773065469493248,
	108543451267596288,
	3472344795593048064,
	108510474475143168,
	2283394837564620800,
	4469266304117114368,
	2247773065779871744,
	292200926070964224,
	1963487754528489472,
	4296168096839761920,
	544402505203712000,
	4577643060732624896,
	2019308110157847552,
	434041037028460032,
	507794172586755840,
	8362571908251648,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	4589637119482380160,
	0,
	436584246077818368,
	297014948823761920,
	4576505012035984896,
	4800510952538112,
	296960631856902528,
	434041011258656256,
	2175308102381965056,
	6912,
	2242984628168204032,
	69482893549312,
	3898724862696357888,
	6781920864108544,
	0,
	2242971451141431040,
	7936,
	34306885525248,
	2233789830922503168,
	69295475367680,
	34297934356224,
	264192,
	108543451572842880,
	1446805668728618496,
	17179869184,
	145241087982698496,
	69320974274304,
	34298295066368,
	980436833701724160,
	2314915806191911168,
	4037498648567841024,
	2314913611463655808,
	2247720140416224256,
	3584779107923395072,
	3584779107923396608,
	3584779107923788800,
	3584779107923792896,
	3584779107923139328,
	3584779107923791360,
	4435359252316372480,
	145275385472458496,
	4576096483811787264,
	4576096483811788800,
	4576096483812180992,
	4576096483811531520,
	4579613325440320000,
	4579613325440321536,
	4579613325440713728,
	4579613325440064256,
	1088520049261219584,
	3583094761932329984,
	2247773065469755904,
	2247773065469757440,
	2247773065470149632,
	2247773065470153728,
	2247773065469500160,
	1227798289693278208,
	2247775282120466176,
	2247773065780134400,
	2247773065780135936,
	2247773065780528128,
	2247773065779878656,
	1012781264497018880,
	117007492082270592,
	2140812488128171776,
	4553630911647973888,
	4553630911647975424,
	4553630911648367616,
	4553630911648371712,
	4553630911647718144,
	4553630911648370176,
	2271713850988429312,
	145310363686993920,
	2234277659750433280,
	2234277659750434816,
	2234277659750827008,
	2234277659750177536,
	4579048167060013568,
	4579048167060015104,
	4579048167060407296,
	4579048167059757824,
	2247773066007940096,
	3580838555180209152,
	2247772985492767232,
	2247772985492768768,
	2247772985493160960,
	2247772985493165056,
	2247772985494274048,
	288264461079281664,
	2248340447829164032,
	2247773064949662208,
	2247773064949663744,
	2247773064950055936,
	2247773064951169024,
	544402505203976192,
	108543451267694976,
	544402505203718912,
};
//const uint64_t haloo3d_print_basic_glyphs[256] = {
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    0,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    0,
//    27286515379863648,
//    61036401134665728,
//    61358078227512536,
//    9286067055097888,
//    37520388433433992,
//    63526353221029112,
//    27127289393184768,
//    15868979679617080,
//    63103274824773856,
//    60922667984748544,
//    137992085536,
//    1616912448,
//    16252928,
//    24672,
//    2278395874476288,
//    70260500491783416,
//    67606977935585532,
//    70241305799787004,
//    70241254382603512,
//    17008128708840460,
//    143413665499811064,
//    70242858578054392,
//    143424798664475008,
//    70242905822694648,
//    70242905864637688,
//    413927497824,
//    413927497760,
//    242411925560,
//    4160813056,
//    963955421408,
//    70241254388007008,
//    70243046284427512,
//    31764399387413900,
//    142300504155590136,
//    70242856564002040,
//    140061896669501936,
//    143413158248284668,
//    143413158248284544,
//    71355563338730748,
//    111901206737948044,
//    70984677656113404,
//    16901744509160696,
//    111914555028904332,
//    108510259257115132,
//    111989647362329996,
//    111971986726292876,
//    70242908305722616,
//    142300504154800512,
//    70242908308871412,
//    142300504157952396,
//    70242854257921272,
//    70984677656113200,
//    111901204858899704,
//    111901204847030304,
//    111901344182144396,
//    111988525359553932,
//    57646073810792496,
//    143020316906603004,
//    70017728324354296,
//    36240316375239684,
//    69832285986756856,
//    9131278913765376,
//    508,
//    18049582881570816,
//    1065369832700,
//    108510774855306744,
//    1071820934392,
//    3391982861651196,
//    1071829057784,
//    33884733781860448,
//    1088992054520,
//    108510774855306636,
//    13511830482727420,
//    3377751462350072,
//    108510311206721932,
//    108510259257073724,
//    2171872325036,
//    2171333348748,
//    1071821720824,
//    2171340423552,
//    1088992054284,
//    1897528394112,
//    1088807505400,
//    27129334340804732,
//    1707476880632,
//    1707465011232,
//    1708015877336,
//    2048572586460,
//    1707465011680,
//    2182790308348,
//    15868567893336120,
//    27127564814278752,
//    63103378442432736,
//    3987585024,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    143426159983824380,
//    0,
//    27022014123405408,
//    9281723391866912,
//    34002147725066748,
//    150015967266816,
//    111702070488266784,
//    27127563203666016,
//    67978378199436408,
//    60798594969501696,
//    70093270435562744,
//    69820077355827200,
//    467508713580,
//    4162328576,
//    0,
//    70093133530334456,
//    69805794224242688,
//    70260501555707904,
//    9043449317687544,
//    70241442974138368,
//    70241448007041024,
//    4538783999459328,
//    111901204865974656,
//    35160083652945960,
//    536870912,
//    8256,
//    67606977948942336,
//    70242908295921664,
//    1859056884144,
//    36451647653413892,
//    36451664563539996,
//    108157396892517380,
//    13511009092340984,
//    18050067567869324,
//    4539268685757836,
//    9095644871261580,
//    11347444684946828,
//    60799079655800204,
//    31613643008114060,
//    35168642810360252,
//    70242856756322368,
//    18051771200012796,
//    4540972317901308,
//    9097348503405052,
//    60800783287943676,
//    18051766611374588,
//    4540967729263100,
//    9097343914766844,
//    60800778699305468,
//    67792373363300592,
//    11348668551372172,
//    18050654703291640,
//    4539855821180152,
//    9096232006683896,
//    11348031820369144,
//    60799666791222520,
//    585459847304,
//    70242977566264568,
//    18051290358451448,
//    4540491476339960,
//    9096867661843704,
//    60800302446382328,
//    4540491466567792,
//    108642252394199424,
//    68004457988599224,
//    18050648251403516,
//    4539849369292028,
//    9096225554795772,
//    11348025368481020,
//    60799660339334396,
//    31614223691648252,
//    2166508839416,
//    278732656615488,
//    18050654710628600,
//    4539855828517112,
//    9096232014020856,
//    60799666798559480,
//    18050614482186748,
//    4539815600075260,
//    9096191785579004,
//    60799626570117628,
//    13538276162768120,
//    11349131331997068,
//    18049587068374264,
//    4538788186262776,
//    9095164371766520,
//    11346964185451768,
//    237498698403064,
//    137455206432,
//    1072092269816,
//    18049589551402232,
//    4538790669290744,
//    9095166854794488,
//    237501181431032,
//    4540491464471008,
//    108510774862381440,
//    60800302434513376
//};
// clang-format on

void haloo3d_print_initdefault(haloo3d_print_tracker *t, char *buf,
                               int buflen) {
  t->scale = 1;
  t->bcolor = 0xF000;
  t->fcolor = 0xFFFF;
  t->glyphs = haloo3d_print_basic_glyphs;
  t->buffer = buf;
  t->buflen = buflen;
  // NOTE: don't forget to set fb
}

void haloo3d_print_refresh(haloo3d_print_tracker *t) {
  t->x = 0;
  t->y = 0;
}

void haloo3d_print(haloo3d_print_tracker *t, const char *fmt, ...) {
  va_list args;
  va_start(args, fmt);
  vsnprintf(t->buffer, t->buflen, fmt, args);
  va_end(args);
  haloo3d_fb tex;
  uint16_t buffer[H3D_PRINT_CHW * H3D_PRINT_CHH];
  tex.buffer = buffer;
  tex.width = H3D_PRINT_CHW;
  tex.height = H3D_PRINT_CHH;
  haloo3d_recti srect;
  haloo3d_recti trect = {
      .x1 = 0, .y1 = 0, .x2 = H3D_PRINT_CHW, .y2 = H3D_PRINT_CHH};
  const int len = strlen(t->buffer);
  for (int i = 0; i < len; i++) {
    if (t->buffer[i] == '\n') {
      t->y += t->scale * H3D_PRINT_CHH;
      t->x = 0;
      continue;
    }
    // We don't support word wrap btw
    haloo3d_print_convertglyph(t->glyphs[(int)t->buffer[i]], t->bcolor,
                               t->fcolor, &tex);
    srect.x1 = t->x;
    srect.y1 = t->y;
    srect.x2 = srect.x1 + t->scale * H3D_PRINT_CHW;
    srect.y2 = srect.y1 + t->scale * H3D_PRINT_CHH;
    haloo3d_sprite(t->fb, &tex, trect, srect);
    t->x += t->scale * H3D_PRINT_CHW;
  }
}

void haloo3d_print_convertglyph(uint64_t glyph, uint16_t bcolor,
                                uint16_t fcolor, haloo3d_fb *out) {
  for (int i = 0; i < H3D_PRINT_CHW * H3D_PRINT_CHH; i++) {
    if (glyph & 1) {
      out->buffer[i] = fcolor;
    } else {
      out->buffer[i] = bcolor;
    }
    glyph >>= 1;
  }
}
